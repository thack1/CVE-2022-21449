module CVE_2022_21449;

export {
	redef enum Notice::Type += {
		## A null signature was encountered
		Null_Signature
	};
}

# maps hashing algorithms to signatures that are zero mod n
global signature_map: table[count] of set[string] = {
	# ecdsa_secp256r1_sha256
	#  n = 0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551
	[4] = set("3026022100ffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551020100", # r=n, s=0
		     "3026020100022100ffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551", # r=0, s=n
		     "3046022100ffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551022100ffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551"), # r=s=n

	# ecdsa_secp384r1_sha384
	# n = 0xffffffffffffffffffffffffffffffffffffffffffffffffc7634d81f4372ddf581a0db248b0a77aecec196accc52973
	[5] = set("3036023100ffffffffffffffffffffffffffffffffffffffffffffffffc7634d81f4372ddf581a0db248b0a77aecec196accc52973020100", # r=n, s=0
			"3036020100023100ffffffffffffffffffffffffffffffffffffffffffffffffc7634d81f4372ddf581a0db248b0a77aecec196accc52973", # r=0, s=n
			"3066023100ffffffffffffffffffffffffffffffffffffffffffffffffc7634d81f4372ddf581a0db248b0a77aecec196accc52973023100ffffffffffffffffffffffffffffffffffffffffffffffffc7634d81f4372ddf581a0db248b0a77aecec196accc52973"), # r=s=n

	# ecdsa_secp521r1_sha512
	# n = 0x01fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa51868783bf2f966b7fcc0148f709a5d03bb5c9b8899c47aebb6fb71e91386409
	[6] = set("304802430001fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa51868783bf2f966b7fcc0148f709a5d03bb5c9b8899c47aebb6fb71e91386409020100", # r=n, s=0
			"304802010002430001fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa51868783bf2f966b7fcc0148f709a5d03bb5c9b8899c47aebb6fb71e91386409", # r=0, s=n
			"30818A02430001fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa51868783bf2f966b7fcc0148f709a5d03bb5c9b8899c47aebb6fb71e9138640902430001fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa51868783bf2f966b7fcc0148f709a5d03bb5c9b8899c47aebb6fb71e91386409"), # r=s=n
};

event ssl_server_signature(c: connection, signature_and_hashalgorithm: SSL::SignatureAndHashAlgorithm, signature: string)
	{
		const sig_algo = signature_and_hashalgorithm$SignatureAlgorithm;

		# ECDSA
		if ( sig_algo == 3)
		{
			if( bytestring_to_hexstr(signature) == "3006020100020100" ) # r=s=0
				NOTICE([$note=Null_Signature, $conn=c, $msg="Null server signature; potential CVE-2022-21449 exploit attempt"]);

			const hash_algo = signature_and_hashalgorithm$HashAlgorithm;
			if ( hash_algo in signature_map && bytestring_to_hexstr(signature) in signature_map[hash_algo] )
					NOTICE([$note=Null_Signature, $conn=c, $msg="Null server signature; potential CVE-2022-21449 exploit attempt"]);
		}
	}
